# eBPF For Windows Demo - Connection Tracking

## Overview
This project demonstrates the following features in eBPF-For-Windows:
1) Native eBPF program generation.
2) The BPF_PROG_TYPE_SOCK_OPS program type.
3) The bpf_printk helper emitting tracing to ETW.
4) The BPF_MAP_TYPE_RINGBUF map type.

The project provides a real-time list of connections that have been completed along with the source, destination, and duration of each connection.

## Demo Steps
### Native eBPF program generation
Note: These steps are already performed as part of the build process for the project and are repeated here for clarity.

1) Launch a "Developer Command Prompt for VS 2019".
2) For convenience, set an environment variable to point to the root of the eBPF nuget package: ```set EBPF_ROOT=c:\ebpf-for-windows-demo\packages\eBPF-for-Windows.0.1.4\build\native```. Note: This is an example path, replace this with your own path.
3) Change directory to connection_tracker\bpf: ```cd connection_tracker\bpf```.
4) Create a directory to hold build output: ```md out```.
5) Build the eBPF program to an ELF file: ```clang -g -target bpf -O2 -Werror -I%EBPF_ROOT%\include -c conn_track.c -o out\conn_track.o```.
6) Invoke the powershell script to build the native image: ```cd out && powershell -NonInteractive -ExecutionPolicy Unrestricted %EBPF_ROOT%\bin\Convert-BpfToNative.ps1 -ProgramName conn_track.o```.
7) This produces the native eBPF program conn_track.sys.
8) Netsh tools can be used to examine the native eBPF program: ```netsh ebpf show sections conn_track.sys```.

### BPF_PROG_TYPE_SOCK_OPS and BPF_MAP_TYPE_RINGBUF demo
1) Build the ebpf-for-windows-demo as outlined in [Getting Started](https://github.com/microsoft/ebpf-for-windows-demo/blob/main/docs/GettingStarted.md).
2) [Install eBPF-For-Windows](https://github.com/microsoft/ebpf-for-windows/blob/main/docs/GettingStarted.md#installing-ebpf-for-windows) on the target machine.
3) Copy conn_track.sys and conn_tracker.exe to the target machine.
4) Launch conn_tracker.exe.
5) Launch a browser and navigate to any website.
6) Connection tracker will then show the list of connections.

### Viewing bpf_printk output
1) Start an ETW session and add the eBPF-For-Windows provider: ```tracelog -start MyTrace -guid ebpf-printk.guid -rt```.
2) Start a real-time trace consumer: ```tracefmt -rt MyTrace -displayonly -jsonMeta 0```.
3) Launch conn_tracker.exe.
4) Launch a browser and navigate to any website.
5) The real-time trace consumer will then show all the bpf_printk events being generated by the eBPF program.



